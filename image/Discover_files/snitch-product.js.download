var prod_price = 0;
var product_class = "product-block";
var cart_class = "col-right nv-ml-auto mb-20";
var brand_name = "SNITCHPAY";
var brand_colour = "#23821c";
var button_class = "buy-buttons buy-buttons--multiple";
var show_banner = false;
var hide = true;
var cart_algo = 2;
var product_var_id = 0;
var domain = "lifeelements-store.myshopify.com";
var shopify_brand_logo = "https://websdk-assets.s3.ap-south-1.amazonaws.com/shopify-messaging-app/snitchpay_logo.png";

function updateProductPrice() {
  try {
    let varId = window.ShopifyAnalytics.meta.selectedVariantId;
    let vars = window.ShopifyAnalytics.meta.product.variants;
    let var_found = false;
    for (let x of vars) {
      if (x.id == varId) {
        prod_price = x.price;
        var_found = true;
        product_var_id = varId;
      }
    }
    if (!var_found) {
      prod_price = vars[0].price;
      product_var_id = varId;
    }
    // console.log("product-price : ", prod_price);
  } catch (err) {
    // console.log("could not updateProductPrice");
  }
}

function func_x(str1) {
  var x = str1.toString();
  var str = "";
  for (var n = 0; n < x.length; n += 2) {
    str += String.fromCharCode(parseInt(x.substr(n, 2), 16));
  }
  return str;
}

function loadInfoBanner() {
  try {
    if (prod_price != 0) {
      let price_b = prod_price / 300;
      let x = window.matchMedia("(max-width: 700px)");
      price_b = (Math.round(price_b * 100) / 100).toFixed(0);
      let str_b = price_b.toString();
      price_p = (Math.round(prod_price) / 100).toFixed(0);
      let str_p = price_p.toString();
      var html_string3 =
        '<div id="bx-btn1" style="cursor: pointer;"> <divid ="bharatx-text-block-with-price" class="button--full-width" style="color: #000000; background-color: #FFFFFF; width: fit-content; align-items: left; justify-content: space-between; display: flex; max-width: 44rem; width: 100%; padding: 0px 18px; gap: 0px !important;margin: 10px 0px; margin-bottom: 20px !important; flex-direction: column !important; align-items: left; min-height : 45px;"> <div style="display:flex; flex-direction: row"> <div style="display: flex; flex-direction: row; gap: 8px; max-width: 100%; align-items: center"> <p style="font-size:' + (x.matches ? "3.5vw !important" : "17.5px") + '; margin: 0px; font-weight:500; line-height: 20px"> ' +
        'or Pay <span style="font-weight: bold; color: ' +
        brand_colour +
        '; font-weight: 700;">  ₹' +
        str_b +
        '</span> and rest later via </p><img id="brand-logo" style="height: 0.9vw;margin: 0px; padding: 0px" src="' +
        shopify_brand_logo + '"></img> </div> <div style="display: flex; align-items: center"> <img id = "inf" style="max-width: 18px" viewBox="0 0 512 512" src="https://websdk-assets.s3.ap-south-1.amazonaws.com/shopify-messaging-app/info-icon.png"> </img> </div> </div>  <div> No Charges | <span style="font-weight: 700">upto <span style="color:#3FB950; font-weight: 700">Rs.200</span> discount</span> </div>  </div></div><!-- The Modal -->';
      // $(html_string3).insertAfter(document.getElementsByClassName("product__price")[0]);
      document.getElementById("Emi-tab-1").childNodes[1].innerHTML =
        html_string3 +
        document.getElementById("Emi-tab-1").childNodes[1].innerHTML;
      // document.getElementsByClassName(product_class)[0].innerHTML += html_string3  ;
    }
  } catch (err) {
    // console.log("error in displaying banner")
  }
}

function loadCheckoutBanner() {
  //get the value from subtotal
  if (cart_algo == 2) {
    try {
      if (document.getElementById("bx-cart") == null) {
        let str_f = document
          .getElementById("revy-cart-subtotal-price")
          .textContent.substring(4);
        let price_c = parseFloat(str_f.replace(/,/g, ""));

        let price_b = price_c / 3;
        price_b = (Math.round(price_b * 100) / 100).toFixed(0);
        let str_b = price_b.toString();
        price_p = (Math.round(price_c * 100) / 100).toFixed(0);
        let str_p = price_p.toString();
        var html_string3 =
          '<div id="bx-checkout" style="cursor: pointer;"> <divid ="bharatx-text-block-with-price" class="button--full-width" style="color: #000000; width: fit-content; justify-content: space-between; display: flex; max-width: 44rem; width: 100%; gap: 6px;margin: 10px 0px; flex-direction: row; align-items: center; min-height : 45px; margin-top : -5px;"> <div style="display: flex; flex-direction: row; gap: 8px; max-width: 100%; align-items: center"> <p style="font-size: 15px; margin: 0px; font-weight:500; line-height: 20px"> ' +
          'or Pay <span id = "bx_updated_price"; style="font-weight: bold; color: ' +
          brand_colour +
          '; font-weight: 700;">  ₹' +
          str_b +
          '</span> and rest later via </p><img id="brand-logo" style="height: 0.9vw;margin: 0px; padding: 0px" src="' +
          shopify_brand_logo + '"></img> </div> <div style="display: flex; align-items: center"></div> </div></div><!-- The Modal -->';
        $(html_string3).insertAfter(
          document.getElementsByClassName("cart__item-sub cart__item-row")[1]
        );
      }
    } catch {
      // console.log("could not load checkout-banner")
    }
  }
}

function displayPayin3Button() {
  try {
    if (prod_price != 0) {
      let price_b = prod_price / 300;
      price_b = (Math.round(price_b * 100) / 100).toFixed(2);
      let str_b = price_b.toString();
      var html_string3 =
        '<div id="bx-btn-pay-in-3" style="cursor: pointer;"> <div id="bharatx-text-block-with-price" class="hover_x btnAddToCart btn product-form__cart-submit mb-15 product-form__cart-submit--small" style="color: #FFFFFF; background-color: #245cab;height: 60px; align-items: center; justify-content: center; display: flex; width: 100%; padding: 0px 12px; gap: 12px; flex-direction: row; align-items: center;"> <div style="display: flex; flex-direction: row; gap: 8px; max-width: 100%; align-items: center"> <p style="margin: 0px; line-height: 20px;"> Pay in 3 EMIs </p> </div> </div></div>';
      document.getElementsByClassName(button_class)[0].innerHTML =
        html_string3 +
        document.getElementsByClassName(button_class)[0].innerHTML;
    }
  } catch (err) {
    // console.log("error in displaying pay - in 3 button")
  }
}

function displayPayin3Button1() {
  try {
    if (prod_price != 0) {
      let price_b = prod_price / 300;
      price_b = (Math.round(price_b * 100) / 100).toFixed(2);
      let str_b = price_b.toString();
      var html_string3 =
        '<div id="bx-btn-pay-in-3" style="cursor: pointer;"> <div id="bharatx-text-block-with-price" class="button button--xl button--secondary" style="color: #FFFFFF; background-color: #245cab; margin : 10px 0px ;height: 60px; align-items: center; justify-content: center; display: flex; width: 100%; padding: 0px 12px; gap: 12px; flex-direction: row; align-items: center;"> <div style="display: flex; flex-direction: row; gap: 8px; max-width: 100%; align-items: center"> <p style="margin: 0px; line-height: 20px;"> Pay in 3 EMIs </p> </div> </div></div>';
      document.getElementById("recurpay-pdp-widget").innerHTML += html_string3;
    }
  } catch (err) {
    // console.log("error in displaying pay - in 3 button")
  }
}

function loadCartBanner() {
  //get the value from subtotal
  if (cart_algo == 2) {
    try {
      if (document.getElementById("bx-cart") == null) {
        let str_f = document
          .getElementsByClassName("cart__item-sub cart__item-row")[1]
          .childNodes[3].textContent.substring(4);
        let price_c = parseFloat(str_f.replace(/,/g, ""));

        let price_b = price_c / 3;
        price_b = (Math.round(price_b * 100) / 100).toFixed(0);
        let str_b = price_b.toString();
        price_p = (Math.round(price_c * 100) / 100).toFixed(0);
        let str_p = price_p.toString();
        var html_string3 =
          '<div id="bx-cart" style="cursor: pointer;"> <divid ="bharatx-text-block-with-price" class="button--full-width" style="color: #000000; background-color: #FFFFFF;border-top: 1px solid #e5e5e5;border-bottom: 1px solid #e5e5e5; width: fit-content; align-items: center; justify-content: space-between; display: flex; max-width: 44rem; width: 100%; padding: 0px 18px; gap: 6px;margin: 10px 0px; flex-direction: row; align-items: center; min-height : 45px; margin-top : -5px;"> <div style="display: flex; flex-direction: row; gap: 8px; max-width: 100%; align-items: center"> <p style="font-size: 2.3vw !important; margin: 0px; font-weight:500; text-align: center;line-height: 20px">' +
          '<span id = "bx_updated_price"; style="font-weight: bold; color: ' +
          brand_colour +
          '; font-weight: 700;">  ₹' +
          str_b +
          '</span> and rest later via </p><img id="brand-logo" style="height: 0.9vw;margin: 0px; padding: 0px" src="' +
          shopify_brand_logo + `"></img></p> </div> <div style="display: flex; align-items: center"></div> </div></div><!-- The Modal -->`;
        $(html_string3).insertAfter(
          document.getElementsByClassName("cart__item-sub cart__item-row")[1]
        );

        // price_c = price_c/3;
        //   price_c = (Math.round(price_c * 100) / 100).toFixed(2);
        //   if(price_c != 0){
        //     let str_c = price_c.toString();
        //     var html_cart = "<div id=\"bx-cart\" style=\"color: {{ block.settings.color }};background-color: #ffffff;border: 1.5px solid #f0f0f0;width: fit-content;align-items: center;display: flex;width: 100%;max-width: 36rem;padding: 8px 8px;margin: 10px 0px;flex-direction: row;align-items: center;\"> <div style=\"display: flex; flex-direction: column\"> <div style=\"display: flex; flex-direction: row; gap: 12px; max-width: 100%; align-items: center;\"> <img style=\"height: 36px; width: 36px\" src='https://s3.ap-south-1.amazonaws.com/shopify.bharatx.tech/Rupee+And+Cart.gif'> <div style=\"display: flex; flex-direction: column\"> <p style=\"font-size: 12px; margin: 0px; line-height: 16px; font-weight:400\"> Pay <span style=\"color: "+ brand_colour +" ; font-weight: bold\">₹</span> "
        //     + "<span id = \"bx_cart_total\" style=\"color: #00466e ; font-weight: bold\">" + str_c
        //     + "</span> now and rest later by choosing <span style=\"color:" + brand_colour +"; font-weight: bold\">Pay in 3 EMIs with "+ brand_name +" </span> </span> </p> </div> </div> </div></div>"
        //     document.getElementsByClassName(cart_class)[0].innerHTML += html_cart
        //   }
      }
    } catch {
      // console.log("could not load cart-banner")
    }
  }
}

function loadModal() {
  try {
    var modal_html =
      '<div id="bx-modal" style="display: none;justify-content: center; position: fixed; z-index: 2147483649;left: 0; top: 0; border: 0 ;width: 100%; max-width: 100%; height: 100vh; background-color: rgb(18,18,18,0.55); overflow: auto;" class="modal"> <!-- Modal content --> <div class="modal-content" style="background-color: #fefefe; background: transparent; height: calc(100vh - -20%);width: 40%;min-width: 360px;max-width: 420px; display: flex; align-items: center; justify-content: center; border: 0; position: relative"> <div class="image"> <img id="image-popup" style="width: 100%; height: 100%" src="https://websdk-assets.s3.ap-south-1.amazonaws.com/shopify-messaging-app/snitch_popup.png" alt="Pay in 3"> </div> </div></div>';
    var modal = document.getElementById("bx-modal");
    var btn = document.getElementById("bx-btn1");
    btn.onclick = function () {
      if (modal == null) {
        $(modal_html).insertAfter(
          document.getElementsByClassName(
            "product__unit-price product__unit-price--spacing  hide"
          )[0]
        );
        modal = document.getElementById("bx-modal");
        modal.onclick = function () {
          // console.log("modal closed");
          modal.style.display = "none";
        };
        window.onclick = function (event) {
          if (event.target == modal) {
            // console.log("modal closed outside click");
            modal.style.display = "none";
          }
        };
      }
      modal = document.getElementById("bx-modal");
      modal.style.display = "flex";
      // console.log("btn clicked");
    };
  } catch (err) {
    // console.log("Modal Could Not Be Loaded");
  }
}

function personalise() {
  try {
    var bx_id = "73696d706c5f616a6178636172745f646976";
    document.getElementById(func_x(bx_id)).style.display = "none";
  } catch (err) {
    // console.log("err-pr");
  }
}

function updateCartPrice() {
  try {
    if (document.getElementById("bx-cart") != null) {
      let str_f = document
        .getElementsByClassName("cart__item-sub cart__item-row")[1]
        .childNodes[3].textContent.substring(4);
      let price_c = parseFloat(str_f.replace(/,/g, ""));
      let str_c = price_c.toString();
      let price_b = price_c / 3;
      price_b = (Math.round(price_b * 100) / 100).toFixed(2);
      let str_b = price_b.toString();
      document.getElementById("bx_total_price").textContent = "₹" + str_c;
      document.getElementById("bx_updated_price").textContent = "₹" + str_b;
    }
  } catch (err) { }
}

function getRedirectUrl() {
  try {
    const continueButton = document.getElementById("bx-btn-pay-in-3");
    var redirect_url = "";

    continueButton.addEventListener("click", function () {
      console.log("btn-clicked");
      fetch("https://web-v2.bharatx.tech/api/shopify/checkout", {
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        method: "POST",
        body: JSON.stringify({
          domain: domain,
          productVariantId: product_var_id.toString(),
        }),
      })
        .then((response) => response.text())
        .then(
          (data) => (window.location.href = JSON.parse(data).checkoutWebUrl)
        );
      // .then(data => console.log( JSON.parse(data).checkoutWebUrl) );
    });
  } catch (err) {
    console.log(err);
  }
}

function bxops() {
  try {
    var x = window.matchMedia("(max-width: 700px)");
    const brand_logo = document.getElementById("brand-logo");
    if (x.matches) {
      brand_logo.style.height = "2.2vw";
    } else {
      brand_logo.style.height = "0.9vw";
    }
  } catch {

  }
  try {
    if (document.getElementById("bx-btn1") == null) {
      updateProductPrice();
      loadInfoBanner();
      loadModal();
    }

    if (document.getElementById("bx-checkout") == null) {
      loadCheckoutBanner();
    }
  } catch (err) { }
}

window.onload = bxops;

setInterval(bxops, 400);
